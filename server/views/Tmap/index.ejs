<!-- ë¶„í•  -->
<!DOCTYPE html>
<html>

<head>
	<%-include("../Tmapheader")%>
	<link rel="stylesheet" href="/stylesheets/index.css" />
	<script type="text/javascript"></script>
	<script type="text/javascript">
		let placeInfo = {};
		var map;
		var markerInfo;
		//ì¶œë°œì§€,ë„ì°©ì§€ ë§ˆì»¤
		var marker_s, marker_e, marker_p;
		//ê²½ë¡œê·¸ë¦¼ì •ë³´
		var drawInfoArr = [];
		var drawInfoArr2 = [];
		var beatArr = [];
		let beatcnt = 0;

		var chktraffic = [];
		var resultdrawArr = [];
		var resultMarkerArr = [];

		var CafeNote = [];

		function initTmap() {
			// 1. ì§€ë„ ë„ìš°ê¸°
			map = new Tmapv2.Map("map_div", {
				center: new Tmapv2.LatLng(37.49241689559544, 127.03171389453507),
				width: "80%",
				height: "500px",
				zoom: 11,
				zoomControl: true,
				scrollwheel: true
			});

			// 2. ì‹œì‘, ë„ì°© ì‹¬ë³¼ì°ê¸°
			// ë„ë¡œëª… ì£¼ì†Œ ì‚¬ìš© { ì‹œ, ë™, ë¡œ }, {ì•ˆì‚°ì‹œ, ì™€ë™, ì‚¬ì„¸ì¶©ì—´ë¡œ94}

			$("#findLoc").submit((event) => {
				event.preventDefault();
				const city = $("#city").val();
				const gun_gu = $("#gun_gu").val();
				const roadNum = $("#roadNum").val();

				const data = {
					city,
					gun_gu,
					roadNum,
				};

				//const destination = $('#destination').val();
				loadGetAddressFromLonLat(data);
			});

			// 3. ê²½ë¡œíƒìƒ‰ API ì‚¬ìš©ìš”ì²­
			$("#find_btn").click(
				function () {


					//ê¸°ì¡´ ë§µì— ìˆë˜ ì •ë³´ë“¤ ì´ˆê¸°í™”
					//resettingMap();
					const departure = JSON.parse(localStorage.getItem('departure'));
					const destination = JSON.parse(localStorage.getItem('destination'));
					//JSON TYPE EDIT [S]
					$.ajax({
						type: "POST",
						url: "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result",
						async: false,
						data: {
							"appKey": "l7xxabd2c64eec2549daabdf41bb048a9c14",
							"startX": departure.lon,
							"startY": departure.lat,
							"endX": destination.lon,
							"endY": destination.lat,
						},
						success: function (response) {
							findBtnSuccess(response); // findBtn.ejsì— í•¨ìˆ˜ ì„ ì–¸ë˜ì–´ ìˆìŒ
						},
						error: function (request, status, error) {
							console.log("code:" +
								request.status + "\n" +
								"message:" +
								request.responseText +
								"\n" + "error:" + error);
						}
					});
					//JSON TYPE EDIT [E]
				}
			);

			$("#searchBtn").click(function () {
				const searchKeyword = $('#searchKeyword').val();
				const routeData = JSON.parse(localStorage.getItem('routeData'));
				const circleColor = Math.round(Math.random() * 0xffffff).toString(16);
				console.log("routeData : ", routeData);
				//beatcnt = 0;

				for (var i in routeData) { //forë¬¸ [S]

					const geometry = routeData[i].geometry;
					if (typeof (geometry.coordinates[0]) == "object") {
						lng = geometry.coordinates[1][0];
						lat = geometry.coordinates[1][1];
					} else {
						lng = geometry.coordinates[0];
						lat = geometry.coordinates[1];
					}

					if (i > 0) {
						if (typeof (routeData[i - 1].geometry.coordinates[0]) == "object") {
							lastlng = routeData[i - 1].geometry.coordinates[1][0];
							lastlat = routeData[i - 1].geometry.coordinates[1][1];
						} else {
							lastlng = routeData[i - 1].geometry.coordinates[0];
							lastlat = routeData[i - 1].geometry.coordinates[1];
						}
					} else {
						lastlng = lng;
						lastlat = lat;
					}
					console.log("ì´ì „ì¢Œí‘œ: ", lastlng, ", ", lastlat, "\ní˜„ì¬ì¢Œí‘œ: ", lng, ", ", lat);

					if (lastlng < lng) smallLng = lastlng, bigLng = lng;
					else smallLng = lng, bigLng = lastlng;
					if (lastlat < lat) smallLat = lastlat, bigLat = lat;
					else smallLat = lat, bigLat = lastlat;

					if (bigLng - smallLng < bigLat - smallLat) {
						dLng = (bigLng - smallLng) / ((bigLat - smallLat) / 0.008);
						console.log("dLng: ", dLng);
						for (; smallLat + 0.008 < bigLat; smallLng += dLng, smallLat += 0.008) {
							console.log("ì¤‘ê°„ì¢Œí‘œ: ", smallLng, ", ", smallLat);

							const routeInfoObj = {
								//markerImage: "http://topopen.tmap.co.kr/imgs/point.png",
								lng: smallLng,
								lat: smallLat,
								//pointType: null,
							};


							$.ajax({

								method: "GET", // ìš”ì²­ ë°©ì‹
								url: "https://apis.openapi.sk.com/tmap/pois/search/around?version=1&format=json&callback=result", // url ì£¼ì†Œ
								data: {
									"categories": searchKeyword,
									"searchType": "name",
									"searchtypCd": "A",
									"radius": 1,
									"centerLon": routeInfoObj.lng,
									"centerLat": routeInfoObj.lat,
									"appKey": "l7xxabd2c64eec2549daabdf41bb048a9c14",
									"count": 200,
								},
								success: function (response, geometry) {
									searchBtnSuccess(response, geometry,
										circleColor); // searchBtn.ejsì— í•¨ìˆ˜ ì„ ì–¸ë˜ì–´ ìˆìŒ
									beatArr[beatcnt++] = 1;
									$("#instrument_ctrl").css("display", "block");



								},
								error: function (request, status, error) {
									console.log("code:" + request.status + "\n" + "message:" + request
										.responseText +
										"\n" + "error:" + error);
									beatArr[beatcnt++] = 0;

								}
							});
						}
					} else {
						dLat = (bigLat - smallLat) / ((bigLng - smallLng) / 0.008);
						console.log("dLat: ", dLat);
						for (; smallLng + 0.008 < bigLng; smallLng += 0.008, smallLat += dLat) {
							console.log("ì¤‘ê°„ì¢Œí‘œ: ", smallLng, ", ", smallLat);

							const routeInfoObj = {
								//markerImage: "http://topopen.tmap.co.kr/imgs/point.png",
								lng: smallLng,
								lat: smallLat,
								//pointType: null,
							};


							$.ajax({

								method: "GET", // ìš”ì²­ ë°©ì‹
								url: "https://apis.openapi.sk.com/tmap/pois/search/around?version=1&format=json&callback=result", // url ì£¼ì†Œ
								data: {
									"categories": searchKeyword,
									"searchType": "name",
									"searchtypCd": "A",
									"radius": 1,
									"centerLon": routeInfoObj.lng,
									"centerLat": routeInfoObj.lat,
									"appKey": "l7xxabd2c64eec2549daabdf41bb048a9c14",
									"count": 200,
								},
								success: function (response, geometry) {
									searchBtnSuccess(response, geometry,
										circleColor); // searchBtn.ejsì— í•¨ìˆ˜ ì„ ì–¸ë˜ì–´ ìˆìŒ
									beatArr[beatcnt++] = 1;
									$("#instrument_ctrl").css("display", "block");



								},
								error: function (request, status, error) {
									console.log("code:" + request.status + "\n" + "message:" + request
										.responseText +
										"\n" + "error:" + error);
									beatArr[beatcnt++] = 0;

								}
							});
						}
					}

					//return false;

					// Marker ì¶”ê°€
					//addMarkers(routeInfoObj);
				}
				localStorage.setItem(searchKeyword, JSON.stringify(beatArr));
				beatcnt = 0;
			});
		}
	</script>

	<%-include("findLoc")%>
	<%-include("findBtn")%>
	<%-include("searchBtn")%>
	<%-include("playBeat")%>

	<script type="text/javascript">
		//ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰
		let cnt = 0;

		function addComma(num) {
			var regexp = /\B(?=(\d{3})+(?!\d))/g;
			return num.toString().replace(regexp, ',');
		}

		//ë§ˆì»¤ ìƒì„±í•˜ê¸°
		function addMarkers(infoObj) {
			var size = new Tmapv2.Size(24, 38); //ì•„ì´ì½˜ í¬ê¸° ì„¤ì •í•©ë‹ˆë‹¤.

			if (infoObj.pointType == "P") { //í¬ì¸íŠ¸ì ì¼ë•ŒëŠ” ì•„ì´ì½˜ í¬ê¸°ë¥¼ ì¤„ì…ë‹ˆë‹¤.
				size = new Tmapv2.Size(8, 8);
			}

			marker_p = new Tmapv2.Marker({
				position: new Tmapv2.LatLng(infoObj.lat, infoObj.lng),
				icon: infoObj.markerImage,
				iconSize: size,
				map: map
			});

			resultMarkerArr.push(marker_p);
		}

		//ë¼ì¸ê·¸ë¦¬ê¸°
		function drawLine(arrPoint, traffic) {
			var polyline_;

			polyline_ = new Tmapv2.Polyline({
				path: arrPoint,
				strokeColor: "#DD0000",
				strokeWeight: 6,
				map: map
			});
			resultdrawArr.push(polyline_);

		}

		//ì´ˆê¸°í™” ê¸°ëŠ¥
		function resettingMap() {
			//ê¸°ì¡´ë§ˆì»¤ëŠ” ì‚­ì œ
			marker_s.setMap(null);
			marker_e.setMap(null);

			if (resultMarkerArr.length > 0) {
				for (var i = 0; i < resultMarkerArr.length; i++) {
					resultMarkerArr[i].setMap(null);
				}
			}

			if (resultdrawArr.length > 0) {
				for (var i = 0; i < resultdrawArr.length; i++) {
					resultdrawArr[i].setMap(null);
				}
			}

			chktraffic = [];
			drawInfoArr = [];
			resultMarkerArr = [];
			resultdrawArr = [];
		}
		//ì•…ê¸° ì„ íƒ


		function a() {
			const inst = $('.inst:checked').val();
			const category = $('#searchKeyword').val();
			if (category == '') {
				alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”!');
				return false;
			}
			localStorage.setItem(inst, category);
			$(`#${inst}`).css("display", "none");
			$(`label[for=${inst}]`).css("display", "none");
			$('#searchKeyword').val('');
			cnt++;
			if (cnt === 4) {

				location.href = "/sequencer";


			}

		}
	</script>

</head>

<body onload="initTmap();  localStorage.setItem('status',0);">
	<div id="instrument_ctrl" style="display: none;">
		<br>
		<span>í˜„ì¬ ì¹´í…Œê³ ë¦¬ë¥¼ ì–´ë–¤ ì•…ê¸°ë¡œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span>
		<form id="selectInst">

			<input type="radio" class="inst" id="kick" name="box1" value="kick">
			<label for="kick">kick</label>
			<input type="radio" class="inst" id="shake" name="box1" value="shake">
			<label for="shake">shake</label>
			<input type="radio" class="inst" id="tom" name="box1" value="tom">
			<label for="tom">tom</label>
			<input type="radio" class="inst" id="snare" name="box1" value="snare">
			<label for="snare">snare</label>
			<button id="inst_Btn" onclick="a()" type="button" style="border:none;">ğŸ¥</button>
		</form>
		<br>
	</div>
	<div class="ft_area">
		<div class="ft_select_wrap">

			<input id="searchKeyword"></input>
			<button id="searchBtn">ì¹´í…Œê³ ë¦¬</button>

			<form id="findLoc">
				<span id="locLabel">departure</span>
				<input id="city" placeholder="ì‹œ/ë„" required></input>
				<input id="gun_gu" placeholder="ì‹œ/êµ°/êµ¬" required></input>
				<input id="roadNum" placeholder="ë„ë¡œëª… + ë²ˆì§€" required></input>
				<button id="submitBtn">get LatLng</button>
			</form>
			<button id="find_btn" style="display:none">ê¸¸ì°¾ê¸°</button>
		</div>

	</div>

	<div id="map_wrap" class="map_wrap">
		<div id="map_div"></div>
	</div>

	<p id="result"></p>
	<br />

</body>

</html>